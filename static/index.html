<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="components/bootstrap.css/css/bootstrap.css">
    <script src="components/jquery/jquery.min.js"></script>    
    <script src="components/underscore/underscore-min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">   
  </head>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="/browser-stats.js"></script>
  <script>

    $(function() {
      BrowserStats.load(function(browsers) {
        var features = browsers.features;
        var features;
        var feats = _.sortBy(_.keys(features), function(itm) { return itm; });
        for(var i = 0;feature=features[feats[i]]; i++) {
          $("#features").append("<li><label for='" + feats[i] + "'>" + feature.title + "</label><input type='checkbox' id='" + feats[i] + "'/>")
        }
      
        $("input[type=checkbox]").live('click', function() {
          var checked = $("input:checked").map(function(val, i) { return i.id; } );

          var supportedBy = BrowserStats.browsers.browsersByFeature(checked, ["y", "y x", "a", "a x"]);

          var sum = _.reduce(supportedBy, function(memo, num){ return memo + num.share; }, 0);
          $("#share").text(sum.toFixed(2));

          // Version numbers aren't that interesting here.
          drawTable("#totalShare",["name", "versions", "share"], supportedBy);
          drawTable("#mobileDesktopSplit",["name", "share"], BrowserStats.browsers.typesByFeature(checked, ["y", "y x", "a", "a x"])); 
        });
      });
    });

    var drawTable = function(element, columns, data) {
   
      var table = d3.select(element).html("").append("table"),
          thead = table.append("thead"),
          tbody = table.append("tbody");

      thead.append("tr")
           .selectAll("th")
           .data(columns)
           .enter()
           .append("th")
             .text(function(col) { 
                return col;
              });
 
      var rows = tbody.selectAll("tr")
                      .data(data)
                      .enter()
                      .append("tr");

      var cells = rows.selectAll('tr')
                      .data(function(row) {
                         return columns.map(function(col) {
                            if(col === "share") 
                              return {column: col, value:row[col].toFixed(3) + "%"};
                            else
                              return {column: col, value:row[col]};
                         })
                      })
                      .enter()
                      .append("td")
                         .text(function(d) { return d.value; }) 
       
    };

    var drawPie = function(element, data) {
      var width = 400,
         height = 400,
         radius = Math.min(width, height) / 2;

      var color = d3.scale.ordinal()
          .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

      var arc = d3.svg.arc()
          .outerRadius(radius - 10)
          .innerRadius(0);

      var pie = d3.layout.pie()
          .sort(function(a, b) { return d3.ascending(a.share, b.share); })
          .value(function(d) { return d.share; });

      var svg = d3.select(element)
          .html("").append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      var g = svg.selectAll(".arc")
          .data(pie(data))
          .enter().append("g")
          .attr("class", "arc");

      g.append("path")
       .attr("d", arc)
       .style("fill", function(d) { 
         return color(d.data.name);
        })
       .append("svg:title")
       .text(function(d) { return d.data.name + " " + d.data.share.toFixed(2) + "%"; });

      g.append("text")
       .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
       .attr("dy", ".35em")
       .style("text-anchor", "middle")
       .style("font-size", function(d) { return d.data.share + "px"; })
       .text(function(d) { 
         return d.data.name + " ("  + d.data.share.toFixed(2)  + "%)"; 
       })
  
   };

</script>

  <style>
    #features { float: left; }
    #result { float: right; font-size:1em; position: fixed; right: 0;}
    #share { font-weight: 700; }
    #charts { font-size: 16px; }
  </style>
  <body>
   <ul id="features"></ul>
   <div id="result">
      <header>
        <h1><span id="share">100</span>% of the web</h1>
      </header>
      <section>
        <div id="#charts">
          <div id="mobileDesktopSplit"></div>
          <div id="totalShare"></div>
        </div>
      </section>
   </div>
  </body>
</html>
